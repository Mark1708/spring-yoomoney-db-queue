# spring-yoomoney-db-queue
> Разработка и применение очереди сообщений на основе базы данных PostgreSQL

## Задачи
### Цель исследования
Целью научно-исследовательской работы являлась разработка системы с применением очереди сообщений на основе базы данных PostgreSQL. 
Основной фокус был направлен на достижение высокой пропускной способности очереди, а именно **1000 RPS** (запросов в секунду), 
и изучение преимуществ и недостатков такого подхода.

### Задачи и этапы исследования
Разработка библиотеки для взаимодействия с базой данных как с брокером сообщений
Подготовка базы данных
Проектирование и разработка 2 сервисов Producer и Consumer, 
которые будут передавать и получать данные через брокер сообщений
Тестирование

## Результаты
Достижение высокой пропускной способности
Для достижения высокой пропускной способности потребовались изменения на 3 уровнях:
1. База данных
    * Партиционирование таблицы для работы с ней как с очередью сообщений
        > Было выполнено секционирование по хешу id сообщения.
    * Индексация полей таблицы для ускорения процесса чтения данных
        > Для индекса были выбраны поля по которым производится фильтрация данных при запросе на чтение, а именно queue_name, next_process_at, id с применением алгоритма индексации - btree.
2. Приложение
   * Оптимизация способов передачи и получения данных
        > Для составления запроса на чтение используется Common Table Expression (CTE) так как такие запросы дополнительно оптимизируются при выполнении. Также чтение батчами по несколько сообщений позволило значительно ускорить извлечение данных из очереди.
   * Многопоточный Consumer
        > Реализовал параллельную обработку данных на уровне приложения, что позволило увеличить объём обрабатываемых данных.
3. Масштабирование
   >    Чтобы обеспечить высокую пропускную способность было развернуто несколько инстансев producer и consumer, что позволило обеспечить достаточную загрузку очереди и кол-во одновременно обрабатываемых сообщений

Пропускная способность очереди была успешно достигнута и даже превзошла - **2300 RPS**.
### Преимущества и недостатки подхода
Преимущества:
* Низкая стоимость масштабирования.
* Удобство в случаях если требуется обрабатывать слишком долгие процессы и в очереди может быть накопленной много данных.
* Удобство настройки благодаря spring-boot-starter-db-queue.
* Гибкая платформа для реализации разных способов взаимодействия с очередью сообщений.

Недостатки:
* Является антипаттерном в большинстве случаев.
* Наличие скоростных ограничений.
* Наличие сложности организации совместной работы нескольких сервисов.
### Анализ результатов тестирования
Результаты тестирования показали стабильную работу системы при максимальной нагрузке.
Показатели нагрузки в течение тестирования  и анализ метрик позволяют сделать выводы о эффективности и устойчивости разработанного подхода.

<p align="center">
  <img width="auto" height="300" src="assets/latency.png">
</p>
<p align="center">Рисунок 1. Задержка (min/avg/max)</p>

<p align="center">
  <img width="auto" height="250" src="assets/RPS.png">
</p>
<p align="center">Рисунок 2. Кол-во запросов в секунду</p>

### Выводы и дальнейшие перспективы
Разработанный подход нашел успешное применение для решения задачи обработки сообщений с высокой нагрузкой, однако во многих случаях этого недостаточно. Тем не менее использование такого подхода по-прежнему распространено для решения ряда специфических задач.
Дальнейшие исследования будут включать в себя эксперименты с настройками базы данных, конфигураций consumer/producer и масштабированием.



